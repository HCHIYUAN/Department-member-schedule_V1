<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部門動態管理系統 V8 (格式修復/穩定版)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap');

        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .avatar-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 selection:bg-indigo-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            User, Briefcase, Calendar, Plane, Home, Clock, Plus, X, 
            ChevronLeft, ChevronRight, LayoutGrid, List, CalendarDays, Edit3, Settings, Trash2, Save, CalendarRange, AlertCircle
        } from 'lucide-react';

        // --- 設定與常數 ---
        const WORK_START_HOUR = 8;
        const WORK_END_HOUR = 17; 

        // 產生 08:00 ~ 18:00 的時間選項 (每30分鐘一格)
        const TIME_OPTIONS = [];
        for (let h = WORK_START_HOUR; h <= 18; h++) {
            const hourStr = h < 10 ? `0${h}` : `${h}`;
            TIME_OPTIONS.push(`${hourStr}:00`);
            if (h < 18) {
                TIME_OPTIONS.push(`${hourStr}:30`);
            }
        }

        const STATUS_TYPES = {
            office: { id: 'office', label: '出勤', color: 'bg-white text-emerald-600 border-emerald-200 ring-1 ring-emerald-100', circle: 'bg-emerald-50 text-emerald-600 border border-emerald-200', icon: User },
            meeting: { id: 'meeting', label: '會議', color: 'bg-blue-50 text-blue-700 border-blue-200', circle: 'bg-blue-500 text-white', icon: Briefcase },
            trip: { id: 'trip', label: '出差', color: 'bg-orange-50 text-orange-700 border-orange-200', circle: 'bg-orange-500 text-white', icon: Plane },
            leave: { id: 'leave', label: '休假', color: 'bg-rose-50 text-rose-700 border-rose-200', circle: 'bg-rose-500 text-white', icon: Home },
            break: { id: 'break', label: '下班/休假', color: 'bg-slate-50 text-slate-400 border-slate-200', circle: 'bg-slate-200 text-slate-400', icon: Clock },
        };

        const INITIAL_MEMBERS = Array.from({ length: 12 }, (_, i) => ({
            id: i + 1,
            name: `成員${i + 1}`,
            role: i === 0 ? '主管' : '專員',
        }));

        // --- 輔助函數 ---
        // 將 ISO 字串拆分為 [YYYY-MM-DD, HH:mm]
        const splitIsoString = (isoStr) => {
            const date = new Date(isoStr);
            const pad = (n) => n < 10 ? '0' + n : n;
            const datePart = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
            const timePart = `${pad(date.getHours())}:${pad(date.getMinutes())}`;
            return { datePart, timePart };
        };

        const formatTime24 = (dateStr) => {
            const d = new Date(dateStr);
            const pad = (n) => n < 10 ? '0' + n : n;
            return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };

        const isSameDay = (d1, d2) => {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        };

        const isDateInRange = (checkDate, startStr, endStr) => {
            const check = new Date(checkDate);
            check.setHours(0, 0, 0, 0);
            const start = new Date(startStr);
            start.setHours(0, 0, 0, 0);
            const end = new Date(endStr);
            end.setHours(0, 0, 0, 0);
            return check.getTime() >= start.getTime() && check.getTime() <= end.getTime();
        };

        // 嚴格的週末檢查 (確保用本地時間)
        const isWeekend = (dateStr) => {
            // dateStr 格式如 "2023-11-28"
            // 加上 T00:00:00 確保瀏覽器以本地時間解析，而非 UTC
            const d = new Date(dateStr.includes('T') ? dateStr : dateStr + 'T00:00:00');
            const day = d.getDay();
            return day === 0 || day === 6; // 0=Sun, 6=Sat
        };

        // --- 主程式 ---
        function App() {
            // Data State (升級 key 為 v8 以確保資料格式正確)
            const [members, setMembers] = useState(() => {
                const saved = localStorage.getItem('dept_members_v8');
                return saved ? JSON.parse(saved) : INITIAL_MEMBERS;
            });
            const [schedules, setSchedules] = useState(() => {
                const saved = localStorage.getItem('dept_schedules_v8');
                return saved ? JSON.parse(saved) : [];
            });

            const [currentView, setCurrentView] = useState('dashboard'); 
            const [viewDate, setViewDate] = useState(new Date()); 
            
            const [isManageModalOpen, setIsManageModalOpen] = useState(false);
            const [isMemberEditModalOpen, setIsMemberEditModalOpen] = useState(false);
            const [targetMember, setTargetMember] = useState(null); 
            const [modalMode, setModalMode] = useState('list');
            
            const [statusForm, setStatusForm] = useState({ 
                id: null, 
                type: 'meeting', 
                startDate: '', startTime: '08:00',
                endDate: '', endTime: '17:00',
                note: '' 
            });
            const [memberForm, setMemberForm] = useState({ name: '', role: '' });

            useEffect(() => { localStorage.setItem('dept_members_v8', JSON.stringify(members)); }, [members]);
            useEffect(() => { localStorage.setItem('dept_schedules_v8', JSON.stringify(schedules)); }, [schedules]);

            // --- 核心邏輯 ---
            const getMemberCurrentStatus = (memberId, time) => {
                const checkTime = time.getTime();
                
                const currentSchedules = schedules.filter(s => 
                    s.memberId === memberId && 
                    new Date(s.start).getTime() <= checkTime && 
                    new Date(s.end).getTime() > checkTime
                );

                if (currentSchedules.length > 0) {
                    const active = currentSchedules[currentSchedules.length - 1];
                    return { ...active, isDefault: false };
                }

                const hour = time.getHours();
                const day = time.getDay();
                const isWorkDay = day >= 1 && day <= 5;
                const isWorkTime = isWorkDay && hour >= WORK_START_HOUR && hour < WORK_END_HOUR;

                if (isWorkTime) {
                    return { type: 'office', note: '在位子上', isDefault: true };
                } else {
                    return { type: 'break', note: isWorkDay ? '非辦公時間' : '假日', isDefault: true };
                }
            };

            const getMemberDaySchedules = (memberId, date) => {
                return schedules.filter(s => 
                    s.memberId === memberId && isDateInRange(date, s.start, s.end)
                );
            };

            // --- 操作處理 ---
            const handleEditMember = (member) => {
                setTargetMember(member);
                setMemberForm({ name: member.name, role: member.role });
                setIsMemberEditModalOpen(true);
            };

            const saveMemberInfo = (e) => {
                e.preventDefault();
                setMembers(prev => prev.map(m => m.id === targetMember.id ? { ...m, ...memberForm } : m));
                setIsMemberEditModalOpen(false);
            };

            const openManageModal = (member, mode = 'list', baseDate = viewDate) => {
                setTargetMember(member);
                setModalMode(mode);

                const pad = (n) => n < 10 ? '0' + n : n;
                const defaultDateStr = `${baseDate.getFullYear()}-${pad(baseDate.getMonth() + 1)}-${pad(baseDate.getDate())}`;

                setStatusForm({
                    id: null,
                    type: 'trip', 
                    startDate: defaultDateStr,
                    startTime: '08:00',
                    endDate: defaultDateStr,
                    endTime: '17:00',
                    note: ''
                });
                
                setIsManageModalOpen(true);
            };

            const loadScheduleToForm = (schedule) => {
                const start = splitIsoString(schedule.start);
                const end = splitIsoString(schedule.end);

                setStatusForm({
                    id: schedule.id,
                    type: schedule.type,
                    startDate: start.datePart,
                    startTime: start.timePart,
                    endDate: end.datePart,
                    endTime: end.timePart,
                    note: schedule.note || ''
                });
                setModalMode('add'); 
            };

            const saveStatus = (e) => {
                e.preventDefault();
                
                // 1. 檢查週末
                if (isWeekend(statusForm.startDate) || isWeekend(statusForm.endDate)) {
                    alert("⚠️ 無法設定行程：週六與週日為固定休假日。");
                    return;
                }

                // 2. 組合時間 (強制補上秒數 :00 避免 Safari/iOS 解析錯誤)
                const startIso = `${statusForm.startDate}T${statusForm.startTime}:00`;
                const endIso = `${statusForm.endDate}T${statusForm.endTime}:00`;
                
                if (new Date(startIso) >= new Date(endIso)) {
                    alert("⚠️ 結束時間必須晚於開始時間");
                    return;
                }

                const newId = statusForm.id || Date.now();
                const newSchedule = {
                    id: newId,
                    memberId: targetMember.id,
                    type: statusForm.type,
                    start: startIso,
                    end: endIso,
                    note: statusForm.note
                };

                setSchedules(prev => {
                    const filtered = prev.filter(s => s.id !== newId);
                    return [...filtered, newSchedule];
                });

                // 3. 儲存成功後，切換回列表模式，提供明確的視覺反饋
                setModalMode('list');
            };

            const deleteSchedule = (id) => {
                if (confirm('確定要刪除這筆行程嗎？')) {
                    setSchedules(prev => prev.filter(s => s.id !== id));
                    if (statusForm.id === id) setModalMode('list');
                }
            };

            // --- 迷你月曆 ---
            const MiniMonthGrid = ({ member }) => {
                const year = viewDate.getFullYear();
                const month = viewDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const days = Array.from({ length: daysInMonth }, (_, i) => {
                    const day = i + 1;
                    const date = new Date(year, month, day);
                    const isToday = isSameDay(date, new Date());
                    
                    const daySchedules = getMemberDaySchedules(member.id, date);
                    const event = daySchedules.find(s => s.type === 'trip') 
                               || daySchedules.find(s => s.type === 'leave') 
                               || daySchedules.find(s => s.type === 'meeting');
                    
                    const isWknd = date.getDay()===0 || date.getDay()===6;
                    return { day, event, isToday, isWeekend: isWknd };
                });

                return (
                    <div className="mt-3 pt-3 border-t border-slate-100">
                        <div className="flex justify-between items-end mb-1">
                            <span className="text-[10px] text-slate-400 font-bold uppercase">{month + 1}月</span>
                        </div>
                        <div className="flex flex-wrap gap-0.5">
                            {days.map((d) => {
                                let bgClass = "bg-slate-200"; 
                                if (d.isWeekend) bgClass = "bg-slate-100 opacity-50"; 
                                if (d.event) {
                                    if (d.event.type === 'trip') bgClass = "bg-orange-400";
                                    else if (d.event.type === 'leave') bgClass = "bg-rose-400";
                                    else if (d.event.type === 'meeting') bgClass = "bg-blue-400";
                                } else if (!d.isWeekend) {
                                    bgClass = "bg-emerald-200"; 
                                }
                                return (
                                    <div key={d.day} className={`w-2 h-2 rounded-full ${bgClass} ${d.isToday ? 'ring-1 ring-offset-1 ring-slate-400' : ''}`}
                                        title={`${d.day}日: ${d.event ? STATUS_TYPES[d.event.type].label : (d.isWeekend ? '假日' : '出勤')}`}></div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            // --- 視圖元件 ---
            const DashboardView = () => (
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 animate-in fade-in zoom-in duration-300">
                    {members.map(member => {
                        const statusData = getMemberCurrentStatus(member.id, viewDate);
                        const config = STATUS_TYPES[statusData.type];
                        
                        return (
                            <div key={member.id} className={`bg-white rounded-2xl p-4 border shadow-sm relative group hover:shadow-md transition-all ${config.color.replace('text-', 'border-').split(' ')[2]}`}>
                                <button onClick={(e) => { e.stopPropagation(); openManageModal(member, 'add'); }}
                                    className="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white rounded-full transition-colors z-10 shadow-sm" title="快速新增行程">
                                    <Plus className="w-5 h-5" />
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); handleEditMember(member); }}
                                    className="absolute top-2 right-12 p-1.5 text-slate-300 hover:text-slate-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10" title="編輯成員資料">
                                    <Settings className="w-4 h-4" />
                                </button>
                                <div onClick={() => openManageModal(member, 'list')} className="cursor-pointer">
                                    <div className="flex items-center mb-2">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg shadow-sm ${config.circle} border-0`}>{member.name.charAt(0)}</div>
                                        <div className="ml-3">
                                            <h3 className="font-bold text-slate-800 text-base">{member.name}</h3>
                                            <p className="text-xs text-slate-400">{member.role}</p>
                                        </div>
                                    </div>
                                    <div className={`px-3 py-1.5 rounded-lg text-sm flex items-center justify-between mb-1 ${config.color}`}>
                                        <div className="flex items-center gap-2"><config.icon className="w-4 h-4" /><span className="font-bold">{config.label}</span></div>
                                        <span className="text-[10px] font-mono opacity-70">NOW</span>
                                    </div>
                                    <div className="text-xs text-slate-500 pl-1 h-4 truncate mb-1">{statusData.note}</div>
                                    <MiniMonthGrid member={member} />
                                </div>
                            </div>
                        );
                    })}
                </div>
            );

            const DayView = () => {
                const START_HOUR = 8;
                const END_HOUR = 18;
                const totalHours = END_HOUR - START_HOUR;
                const daySchedules = schedules.filter(s => isDateInRange(viewDate, s.start, s.end));

                return (
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden animate-in slide-in-from-right duration-300">
                        <div className="flex border-b border-slate-100 bg-slate-50">
                            <div className="w-20 md:w-28 flex-shrink-0 p-3 text-xs font-bold text-slate-400 border-r border-slate-100">人員</div>
                            <div className="flex-1 relative h-8">
                                {Array.from({ length: totalHours + 1 }).map((_, i) => (
                                    <div key={i} className="absolute top-0 bottom-0 border-l border-slate-100 text-[10px] text-slate-400 pl-1 pt-2" style={{ left: `${(i / totalHours) * 100}%` }}>{START_HOUR + i}</div>
                                ))}
                            </div>
                        </div>
                        <div className="overflow-y-auto max-h-[65vh]">
                            {members.map(member => {
                                const mySchedules = daySchedules.filter(s => s.memberId === member.id);
                                return (
                                    <div key={member.id} className="flex border-b border-slate-100 hover:bg-slate-50 group">
                                        <div className="w-20 md:w-28 flex-shrink-0 p-3 border-r border-slate-100 flex items-center justify-between">
                                            <div className="text-sm font-bold text-slate-700 truncate">{member.name}</div>
                                            <button onClick={() => openManageModal(member, 'add')} className="opacity-0 group-hover:opacity-100 text-indigo-500"><Plus className="w-4 h-4" /></button>
                                        </div>
                                        <div className="flex-1 relative h-12">
                                            {Array.from({ length: totalHours }).map((_, i) => (
                                                <div key={i} className="absolute top-0 bottom-0 border-r border-slate-50" style={{ left: `${((i + 1) / totalHours) * 100}%`, width: '1px' }}></div>
                                            ))}
                                            {!((viewDate.getDay()===0)||(viewDate.getDay()===6)) && (
                                                <div className="absolute top-1 bottom-1 bg-emerald-50/50" style={{ left: '0%', width: `${((17-8)/totalHours)*100}%` }}></div>
                                            )}
                                            {mySchedules.map(sch => {
                                                const start = new Date(sch.start);
                                                const end = new Date(sch.end);
                                                let startH = isSameDay(start, viewDate) ? start.getHours() + start.getMinutes()/60 : START_HOUR;
                                                let endH = isSameDay(end, viewDate) ? end.getHours() + end.getMinutes()/60 : END_HOUR;
                                                const left = ((Math.max(startH, START_HOUR) - START_HOUR) / totalHours) * 100;
                                                const width = ((Math.min(endH, END_HOUR) - Math.max(startH, START_HOUR)) / totalHours) * 100;
                                                if (Math.min(endH, END_HOUR) <= Math.max(startH, START_HOUR)) return null;

                                                return (
                                                    <div key={sch.id} onClick={() => { setTargetMember(member); loadScheduleToForm(sch); setIsManageModalOpen(true); }}
                                                         className={`absolute top-2 bottom-2 rounded text-[10px] flex items-center px-2 overflow-hidden cursor-pointer hover:opacity-80 border shadow-sm z-10 ${STATUS_TYPES[sch.type].color}`}
                                                         style={{ left: `${left}%`, width: `${width}%` }} title={sch.note}>
                                                        {sch.note || STATUS_TYPES[sch.type].label}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const MonthView = () => {
                const year = viewDate.getFullYear();
                const month = viewDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDayOfWeek = new Date(year, month, 1).getDay();

                return (
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 animate-in fade-in zoom-in duration-300">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-lg font-bold text-slate-700">{year}年 {month + 1}月</h2>
                            <div className="text-xs text-slate-400 flex gap-2">
                                {Object.values(STATUS_TYPES).filter(t => t.id !== 'office').map(t => (
                                    <div key={t.id} className="flex items-center gap-1"><div className={`w-2 h-2 rounded-full ${t.circle.split(' ')[0]}`}></div><span>{t.label}</span></div>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-7 text-center mb-2 border-b border-slate-100 pb-2 text-xs font-bold text-slate-400">
                            {['日', '一', '二', '三', '四', '五', '六'].map(d => <div key={d}>{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-1">
                            {Array.from({ length: startDayOfWeek }).map((_, i) => <div key={`e-${i}`} className="min-h-[80px] bg-slate-50/30 rounded"></div>)}
                            {Array.from({ length: daysInMonth }).map((_, i) => {
                                const date = new Date(year, month, i + 1);
                                const isToday = isSameDay(date, new Date());
                                const isWeekEndDay = (date.getDay()===0 || date.getDay()===6);

                                return (
                                    <div key={i} className={`min-h-[80px] border rounded p-1 flex flex-col gap-1 ${isToday ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'} ${isWeekEndDay ? 'bg-slate-50/50' : ''}`}>
                                        <span className={`text-[10px] font-bold ${isToday ? 'text-indigo-600' : 'text-slate-400'}`}>{i + 1}</span>
                                        <div className="flex flex-wrap gap-1">
                                            {members.map(member => {
                                                if (isWeekEndDay) return null;
                                                const dayEvents = getMemberDaySchedules(member.id, date);
                                                const event = dayEvents.find(s=>s.type==='trip') || dayEvents.find(s=>s.type==='leave') || dayEvents.find(s=>s.type==='meeting') || dayEvents[0];
                                                const config = event ? STATUS_TYPES[event.type] : STATUS_TYPES.office;
                                                return (
                                                    <div key={member.id} onClick={(e) => { e.stopPropagation(); openManageModal(member, 'add', date); }}
                                                         className={`w-5 h-5 rounded-full text-[9px] flex items-center justify-center cursor-pointer hover:scale-125 transition-transform ${config.circle}`}
                                                         title={member.name}>
                                                        {member.name.charAt(0)}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 pb-20">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 glass-panel p-4 rounded-2xl shadow-sm border border-white sticky top-2 z-20">
                        <div className="flex items-center gap-3">
                            <div className="bg-gradient-to-br from-indigo-500 to-purple-600 p-2.5 rounded-xl shadow-lg shadow-indigo-200 text-white"><LayoutGrid className="w-6 h-6" /></div>
                            <div>
                                <h1 className="text-xl font-bold text-slate-800 tracking-tight">部門動態管理</h1>
                                <p className="text-xs text-slate-500 font-medium">{viewDate.toLocaleDateString()} (穩定修復版)</p>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center gap-3 justify-center">
                            <div className="flex bg-slate-200 p-1 rounded-xl">
                                <button onClick={() => setCurrentView('dashboard')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${currentView === 'dashboard' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><LayoutGrid className="w-3.5 h-3.5" /> 看板</button>
                                <button onClick={() => setCurrentView('day')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${currentView === 'day' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><List className="w-3.5 h-3.5" /> 日曆</button>
                                <button onClick={() => setCurrentView('month')} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${currentView === 'month' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><CalendarDays className="w-3.5 h-3.5" /> 月曆</button>
                            </div>
                            <div className="flex items-center bg-white border border-slate-200 rounded-xl px-2 py-1 shadow-sm">
                                <button onClick={() => setViewDate(new Date(viewDate.setDate(viewDate.getDate() - 1)))} className="p-1 hover:bg-slate-100 rounded-lg"><ChevronLeft className="w-4 h-4 text-slate-500" /></button>
                                <div className="mx-2 flex flex-col items-center w-24"><span className="text-xs font-bold text-slate-700">{viewDate.getFullYear()}-{viewDate.getMonth() + 1}-{viewDate.getDate()}</span></div>
                                <button onClick={() => setViewDate(new Date(viewDate.setDate(viewDate.getDate() + 1)))} className="p-1 hover:bg-slate-100 rounded-lg"><ChevronRight className="w-4 h-4 text-slate-500" /></button>
                                <div className="border-l border-slate-200 pl-2 ml-2"><button onClick={() => setViewDate(new Date())} className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100">今天</button></div>
                            </div>
                        </div>
                    </header>

                    <main>
                        {currentView === 'dashboard' && <DashboardView />}
                        {currentView === 'day' && <DayView />}
                        {currentView === 'month' && <MonthView />}
                    </main>

                    {isManageModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
                            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-in zoom-in duration-200 max-h-[90vh] flex flex-col">
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                        {modalMode === 'add' ? <><Plus className="w-4 h-4" /> 新增行程</> : <><CalendarRange className="w-4 h-4" /> 行程列表</>}
                                        <span className="text-slate-400 text-sm font-normal">| {targetMember?.name}</span>
                                    </h3>
                                    <button onClick={() => setIsManageModalOpen(false)}><X className="w-5 h-5 text-slate-400" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    {modalMode === 'add' && (
                                        <form onSubmit={saveStatus} className="space-y-4">
                                            <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100 flex items-start gap-2">
                                                <AlertCircle className="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" />
                                                <p className="text-xs text-yellow-700">週六、週日為固定休假日。</p>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                {Object.values(STATUS_TYPES).filter(t => t.id !== 'office' && t.id !== 'break').map(type => (
                                                    <button key={type.id} type="button" onClick={() => setStatusForm({...statusForm, type: type.id})}
                                                        className={`flex items-center p-3 rounded-xl border text-sm font-medium transition-all ${statusForm.type === type.id ? `${type.color} ring-2 ring-offset-1 ring-indigo-500` : 'border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                                        <type.icon className="w-4 h-4 mr-2" />{type.label}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="space-y-3">
                                                <div className="grid grid-cols-2 gap-3 items-end">
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 block mb-1">開始日期</label>
                                                        <input type="date" required className="w-full p-2 bg-slate-50 border rounded-lg text-sm font-mono" value={statusForm.startDate} onChange={e => setStatusForm({...statusForm, startDate: e.target.value})} />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 block mb-1">時間</label>
                                                        <select value={statusForm.startTime} onChange={e => setStatusForm({...statusForm, startTime: e.target.value})} className="w-full p-2 bg-slate-50 border rounded-lg text-sm font-mono">
                                                            {TIME_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3 items-end">
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 block mb-1">結束日期</label>
                                                        <input type="date" required className="w-full p-2 bg-slate-50 border rounded-lg text-sm font-mono" value={statusForm.endDate} onChange={e => setStatusForm({...statusForm, endDate: e.target.value})} />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 block mb-1">時間</label>
                                                        <select value={statusForm.endTime} onChange={e => setStatusForm({...statusForm, endTime: e.target.value})} className="w-full p-2 bg-slate-50 border rounded-lg text-sm font-mono">
                                                            {TIME_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <textarea placeholder="備註" className="w-full p-3 bg-slate-50 border rounded-lg text-sm h-16 resize-none" value={statusForm.note} onChange={e => setStatusForm({...statusForm, note: e.target.value})}></textarea>
                                            <div className="flex gap-3 pt-2">
                                                <button type="button" onClick={() => setModalMode('list')} className="px-4 py-2 text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-bold">列表</button>
                                                <button type="submit" className="flex-1 py-2 bg-indigo-600 text-white font-bold text-sm rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center justify-center">
                                                    <Save className="w-4 h-4 mr-2" /> 儲存
                                                </button>
                                            </div>
                                        </form>
                                    )}
                                    {modalMode === 'list' && (
                                        <div>
                                            <button onClick={() => setModalMode('add')} className="w-full py-2 mb-4 border border-dashed border-indigo-300 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-50 flex items-center justify-center gap-2"><Plus className="w-4 h-4" /> 新增行程</button>
                                            <div className="space-y-2">
                                                {schedules.filter(s => s.memberId === targetMember.id).sort((a,b) => new Date(a.start) - new Date(b.start)).map(sch => (
                                                    <div key={sch.id} onClick={() => loadScheduleToForm(sch)} className="p-3 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer flex justify-between items-center group">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-2 h-2 rounded-full ${STATUS_TYPES[sch.type].circle.split(' ')[0]}`}></div>
                                                            <div>
                                                                <div className="text-sm font-bold text-slate-700">{STATUS_TYPES[sch.type].label} <span className="text-xs font-normal text-slate-500">({sch.note})</span></div>
                                                                <div className="text-xs text-slate-400 font-mono">
                                                                    {new Date(sch.start).toLocaleDateString()} {formatTime24(sch.start)} ~ {new Date(sch.end).toLocaleDateString()} {formatTime24(sch.end)}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <button onClick={(e) => { e.stopPropagation(); deleteSchedule(sch.id); }} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full"><Trash2 className="w-4 h-4" /></button>
                                                    </div>
                                                ))}
                                                {schedules.filter(s => s.memberId === targetMember.id).length === 0 && <div className="text-center text-xs text-slate-400 py-4">無行程</div>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {isMemberEditModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-in zoom-in duration-200">
                                <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><Edit3 className="w-5 h-5 text-indigo-600" /> 編輯成員資料</h3>
                                <form onSubmit={saveMemberInfo} className="space-y-4">
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">姓名</label><input type="text" required className="w-full p-2 border border-slate-300 rounded-lg" value={memberForm.name} onChange={e => setMemberForm({...memberForm, name: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">職稱</label><input type="text" required className="w-full p-2 border border-slate-300 rounded-lg" value={memberForm.role} onChange={e => setMemberForm({...memberForm, role: e.target.value})} /></div>
                                    <div className="flex justify-end gap-2 pt-2"><button type="button" onClick={() => setIsMemberEditModalOpen(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">取消</button><button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700">更新</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
